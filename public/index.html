<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pete's Vanquis Bank Game</title>
	<script src="/__/firebase/7.15.1/firebase-app.js"></script>
	<script src="/__/firebase/7.15.1/firebase-analytics.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/7.15.1/firebase-auth.js"></script>
    <script defer src="/__/firebase/7.15.1/firebase-database.js"></script>
    <script defer src="/__/firebase/7.15.1/firebase-messaging.js"></script>
    <script defer src="/__/firebase/7.15.1/firebase-storage.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script src="/__/firebase/init.js"></script>
    <script src="CanvasInput.min.js"> </script>
	<script src="CanvasInput.js"> </script>
    
    
    <style media="screen">
      body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      #message { background: white; max-width: 360px; margin: 100px auto 16px; padding: 32px 24px; border-radius: 3px; }
      #message h2 { color: #ffa100; font-weight: bold; font-size: 16px; margin: 0 0 8px; }
      #message h1 { font-size: 22px; font-weight: 300; color: rgba(0,0,0,0.6); margin: 0 0 16px;}
      #message p { line-height: 140%; margin: 16px 0 24px; font-size: 14px; }
      #message a { display: block; text-align: center; background: #039be5; text-transform: uppercase; text-decoration: none; color: white; padding: 16px; border-radius: 4px; }
      #message, #message a { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
      #load { color: rgba(0,0,0,0.4); text-align: center; font-size: 13px; }
      @media (max-width: 600px) {
        body, #message { margin-top: 0; background: white; box-shadow: none; }
        body { border-top: 16px solid #ffa100; }
      }
    </style>
  </head>
<body onload="startGame()">
<script>
	firebase.analytics();
</script>
<div id="loginArea">
	Welcome to the Vanquis Game v0.1 Alpha </br>
	<p id="userpass">Sign in: </p><br>
	<a if="forgotPW" target="_blank" href="./forgot.html">Forgot Password? Click here</a>
	<canvas id="usernamecanvas" width="350" height="100"></canvas>
	<canvas id="passwordcanvas" width="350" height="100"></canvas>
	</br>
	<p id="userpass">Or...</p>
	<button onclick="register()">Register </br> (requires Vanquis Bank Email Account)</button>
	<br>
</div>
<div id="emailVerify">
	<button onclick="sendEmailVerification()">Resend Email Verification</button>
</div>

<div id="signup">
	<label for="fname">Email:</label>
	<input type="text" id="inp_email" name="email"><br><br>
	<label for="fname">Password:</label>
	<input type="password" id="inp_pw" name="pw"><br><br>
	<button onclick="handleSignUp()">Sign up</button>
</div>
<script>
var myGamePiece;
var myObstacles = [];
var myTargets = [];
var myScore;
//target is selected
var targetSelected = true;
var selectedTarget = -1;

//background and stall front images
var mainBackgoundImg = "https://firebasestorage.googleapis.com/v0/b/vanquisgame.appspot.com/o/mainCanvasBackground.png?alt=media&token=ecef3fac-ab06-4375-80f0-e3d4d3b9ff68";
var stallBottom = "https://firebasestorage.googleapis.com/v0/b/vanquisgame.appspot.com/o/stallBottom.png?alt=media&token=f0e58bad-6520-44c3-a410-645fa4f34ac9";

//target images
var targetImg0 = "https://firebasestorage.googleapis.com/v0/b/vanquisgame.appspot.com/o/target1.png?alt=media&token=396992c3-5dbb-4655-b53e-18f974669891";
var targetImg1 = "https://firebasestorage.googleapis.com/v0/b/vanquisgame.appspot.com/o/target2.png?alt=media&token=2dc6ee00-6c33-4175-aefa-780a45397206";
var targetImg2 = "https://firebasestorage.googleapis.com/v0/b/vanquisgame.appspot.com/o/target3.png?alt=media&token=85448202-89f9-43ca-a13b-0a52cce7a207";
var targetImg3 = "https://firebasestorage.googleapis.com/v0/b/vanquisgame.appspot.com/o/target4.png?alt=media&token=efd010c3-01bf-474a-b2d4-33af69be5692";
var targetImg4 = "https://firebasestorage.googleapis.com/v0/b/vanquisgame.appspot.com/o/target5.png?alt=media&token=f2b96a09-4354-4df1-a9f8-1c2e479bdcf5";
var targetImg5 = "https://firebasestorage.googleapis.com/v0/b/vanquisgame.appspot.com/o/target6.png?alt=media&token=cb792400-876b-4b17-8840-df563c6cc472";

//small and large sign target position when coming up
var targetOddY = 180;
var targetEventY = 255;
var interval;
//Sign in details
var email;
var password;
var username;

function startGame() {
    myGamePiece = new component(30, 30, "red", 10, 120);
    myGamePiece.gravity = 0.05;

//Add the Targets
/*
    End states here:
    myTargets.push(new component(70, 75, targetImg1, 65, 255, "image"));
    myTargets.push(new component(70, 150, targetImg2, 105, 180, "image"));
    myTargets.push(new component(70, 75, targetImg3, 150, 255, "image"));
    myTargets.push(new component(70, 150, targetImg4, 195, 180, "image"));
    myTargets.push(new component(70, 75, targetImg5, 240, 255, "image"));
    myTargets.push(new component(70, 150, targetImg6, 285, 180, "image"));

*/
    myTargets.push(new component(70, 75, targetImg0, 65, 330, "image","target0"));
    myTargets.push(new component(70, 150, targetImg1, 105, 330, "image","target1"));
    myTargets.push(new component(70, 75, targetImg2, 150, 330, "image","target2"));
    myTargets.push(new component(70, 150, targetImg3, 195, 330, "image","target3"));
    myTargets.push(new component(70, 75, targetImg4, 240, 330, "image","target4"));
    myTargets.push(new component(70, 150, targetImg5, 285, 330, "image","target5"));


    //Set Stall image
    gameStalls = new component(325, 140, stallBottom, 45, 330, "image");
    
	//score
    myScore = new component("20px", "Consolas", "white", 440, 416, "text");
    
    //Questions remaining
    myRemainingQs = new component("10px", "Consolas", "black", 340, 30, "text");
    questions = 6;
    
	//user
	loggedInUser = new component("10px", "Consolas", "black", 30, 30, "text");
	
	//Get login areas and hide them
	var loginArea = document.getElementById("loginArea")
	loginArea.style.display = "none";
	var emailVerify = document.getElementById("emailVerify")
	emailVerify.style.display = "none";
	var signup = document.getElementById("signup")
	signup.style.display = "none";
	
    firebase.auth().onAuthStateChanged(function(user) { 

                    if (user) {
					//remove login things.
						loginArea.style.display = "none";
						emailVerify.style.display = "none";
						signup.style.display = "none";
                      // User is signed in.
                      var displayName = user.displayName;
                      email = user.email;
                      var emailVerified = user.emailVerified;
                      var photoURL = user.photoURL;
                      var isAnonymous = user.isAnonymous;
                      var uid = user.uid;
                      var providerData = user.providerData;
					  if(emailVerified){
						myGameArea.start();
					  }else{
						alert("Sorry, you need to verify your email to play this game. Please check your inbox.");
						emailVerify.style.display = "block";
					  }					  					  					  
                    }else{
						//Please log in
						myGameArea.loginEmail();
						loginArea.style.display = "block";
					}

     });
    
}

function register() {
	var loginArea = document.getElementById("loginArea")
	loginArea.style.display = "none";
	var emailVerify = document.getElementById("emailVerify")
	emailVerify.style.display = "none";
	var signup = document.getElementById("signup")
	signup.style.display = "block";
}


var myGameArea = {
    canvas : document.createElement("canvas"),
    loginEmail : function() {
            var canv = document.getElementById("usernamecanvas");
            canv.style.display = "block";
            var input = new CanvasInput({
                canvas: document.getElementById("usernamecanvas"),
                 fontSize: 18,
                  fontFamily: 'Arial',
                  fontColor: '#212121',
                  fontWeight: 'bold',
                  width: 300,
                  padding: 8,
                  borderWidth: 1,
                  borderColor: '#000',
                  borderRadius: 3,
                  boxShadow: '1px 1px 0px #fff',
                  innerShadow: '0px 0px 5px rgba(0, 0, 0, 0.5)',
                  placeHolder: 'Please enter your email...',
                  onsubmit: function() {
                  var canv = document.getElementById("usernamecanvas")
                    this.context = canv.getContext("2d");
                    this.context.clearRect(0, 0, 350, 100);
                    canv.style.display = "none";
                    email = input.value();
                    myGameArea.loginPassword();
                  } 
                  
            });
    },
    loginPassword : function() {
        var canv = document.getElementById("passwordcanvas");
        canv.style.display = "block";
        var input2 = new CanvasInput({
                canvas: document.getElementById("passwordcanvas"),
                 fontSize: 18,
                  fontFamily: 'Arial',
                  fontColor: '#212121',
                  fontWeight: 'bold',
                  width: 300,
                  padding: 8,
                  borderWidth: 1,
                  borderColor: '#000',
                  borderRadius: 3,
                  boxShadow: '1px 1px 0px #fff',
                  innerShadow: '0px 0px 5px rgba(0, 0, 0, 0.5)',
                  placeHolder: 'Enter your password...',
                  type: 'password',
                  onsubmit: function() {
                    password = input2.value();
                    if(toggleSignIn()){
                        var canv = document.getElementById("loginArea")
                        canv.style.display = "none";
                        myGameArea.start();
                    }else{
                        alert("Sign in failed.");
                        myGameArea.loginEmail();
                    }
                  } 
            });
    },
    
    start : function() {
            img = new Image();
            img.src = mainBackgoundImg
            this.canvas.width = 588;
            this.canvas.height = 431;
            this.context = this.canvas.getContext("2d");
            document.body.insertBefore(this.canvas, document.body.childNodes[0]);
            if(this.frameNo == null || this.frameNo == 0){
			this.frameNo = 0;
			}
            this.min = Math.ceil(0);
            this.max = Math.floor(myTargets.length-1);
            selectedTarget = Math.floor(Math.random() * (this.max - this.min + 1)) + this.min;
            if(targetSelected == false){
                targetSelected = true
            }
			
			
			//hit start then do this.
            interval = setInterval(updateGameArea, 10);
            this.context.drawImage(img, 10, 10);
            //Add listeners
            var elemLeft = this.canvas.offsetLeft + this.canvas.clientLeft,
                elemTop = this.canvas.offsetTop + this.canvas.clientTop
            // Add event listener for `click` events.
            this.canvas.addEventListener('click', function(event) {
                var x = event.pageX - elemLeft,
                    y = event.pageY - elemTop;
                    //alert('Click recorded ' + x + ' ' + y + 'target 0 Top '+ myTargets[0].y);
                    if (y > myTargets[selectedTarget].y && y < myTargets[selectedTarget].y + myTargets[selectedTarget].height 
                        && x > myTargets[selectedTarget].x && x < myTargets[selectedTarget].x + myTargets[selectedTarget].width) {
                        targetSelected = false
                    }
            }, false);
        },
    clear : function() {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
        img = new Image();
        img.src = mainBackgoundImg
        this.context.drawImage(img, 10, 10);
    }
}

    /**
     * Handles the sign up button press.
     */
    function handleSignUp() {
		email = document.getElementById("inp_email").value;
		password = document.getElementById("inp_pw").value;
      if (email.length < 4) {
        alert('Please enter a valid email address.: '+email);
        return false;
      }
      if (/@gmail.com\s*$/.test(email)) {
        //is Vanquis email
      } 
      else{
        alert("Please enter a Vanquis Bank email account");
        return false;
      }
      if (password.length < 4) {
        alert('Please enter a password.');
        return false;
      }
      // Create user with email and pass.
      // [START createwithemail]
      firebase.auth().createUserWithEmailAndPassword(email, password).catch(function(error) {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        // [START_EXCLUDE]
        if (errorCode == 'auth/weak-password') {
          alert('The password is too weak.');
          return false;
        } else {
          alert(errorMessage);
          return false;
        }
        console.log(error);
        // [END_EXCLUDE]
      });
      // [END
	sendEmailVerification();
	startGame();
    return true;
    }

    /**
     * Handles the sign in button press.
     */
    function toggleSignIn() {
      if (firebase.auth().currentUser) {
        // [START signout]
        firebase.auth().signOut();
        // [END signout]
      } else {
        if (email.length < 4) {
          alert('Please enter an email address.');
          return false;
        }
        if (password.length < 4) {
          alert('Please enter a password.');
          return false;
        }
        // Sign in with email and pass.
        // [START authwithemail]
        firebase.auth().signInWithEmailAndPassword(email, password).catch(function(error) {
          // Handle Errors here.
          var errorCode = error.code;
          var errorMessage = error.message;
          // [START_EXCLUDE]
          if (errorCode === 'auth/wrong-password') {
            alert('Wrong password.');
            return false;
          } else {
            alert(errorMessage);
            return false;
          }
          console.log(error);
          return false;
          // [END_EXCLUDE]
        });
        // [END authwithemail]
      }
      alert("Login Successful!");
      return true;
    }

    /**
     * Sends an email verification to the user.
     */
    function sendEmailVerification() {	
		firebase.auth().onAuthStateChanged(function(user) {
			if(user){
				user.sendEmailVerification().then(function() {
						alert('Email Verification Sent!');
				}, function(error) {
						alert('There was an error');
						console.log(error);
			});
			
			}
		});
      // [END sendemailverification]
    }

    /**
     * initApp handles setting up UI event listeners and registering Firebase auth listeners:
     *  - firebase.auth().onAuthStateChanged: This listener is called when the user is signed in or
     *    out, and that is where we update the UI.
     */
    function initApp() {
      // Listening for auth state changes.
      // [START authstatelistener]
      firebase.auth().onAuthStateChanged(function(user) {
        // [START_EXCLUDE silent]
        document.getElementById('quickstart-verify-email').disabled = true;
        // [END_EXCLUDE]
        if (user) {
          // User is signed in.
          var displayName = user.displayName;
          var email = user.email;
          var emailVerified = user.emailVerified;
          var photoURL = user.photoURL;
          var isAnonymous = user.isAnonymous;
          var uid = user.uid;
          var providerData = user.providerData;
          // [START_EXCLUDE]
          document.getElementById('quickstart-sign-in-status').textContent = 'Signed in';
          document.getElementById('quickstart-sign-in').textContent = 'Sign out';
          document.getElementById('quickstart-account-details').textContent = JSON.stringify(user, null, '  ');
          if (!emailVerified) {
            document.getElementById('quickstart-verify-email').disabled = false;
          }
          // [END_EXCLUDE]
        } else {
          // User is signed out.
          // [START_EXCLUDE]
          document.getElementById('quickstart-sign-in-status').textContent = 'Signed out';
          document.getElementById('quickstart-sign-in').textContent = 'Sign in';
          document.getElementById('quickstart-account-details').textContent = 'null';
          // [END_EXCLUDE]
        }
        // [START_EXCLUDE silent]
        document.getElementById('quickstart-sign-in').disabled = false;
        // [END_EXCLUDE]
      });
      // [END authstatelistener]
    }


function component(width, height, color, x, y, type, name) {
    this.type = type;
    this.name = name;
    this.score = 0;
    this.width = width;
    this.height = height;
    this.speedX = 0;
    this.speedY = 0;    
    this.x = x;
    this.y = y;
    this.gravity = 0;
    this.gravitySpeed = 0;
    this.update = function() {
        ctx = myGameArea.context;
        if (this.type == "text") {
            ctx.font = this.width + " " + this.height;
            ctx.fillStyle = color;
            ctx.fillText(this.text, this.x, this.y);
        } 
       else if (type == "image") {
            this.image = new Image();
            this.image.src = color;
            ctx.drawImage(this.image,
            this.x,
            this.y,
            this.width, this.height);
        }
        else {
            ctx.fillStyle = color;
            ctx.fillRect(this.x, this.y, this.width, this.height);
        }
    }
    this.newPos = function() {
        this.gravitySpeed += this.gravity;
        this.x += this.speedX;
        this.y += this.speedY + this.gravitySpeed;
        this.hitBottom();
    }
    this.hitBottom = function() {
        var rockbottom = myGameArea.canvas.height - this.height;
        if (this.y > rockbottom) {
            this.y = rockbottom;
            this.gravitySpeed = 0;
        }
    }
    this.crashWith = function(otherobj) {
        var myleft = this.x;
        var myright = this.x + (this.width);
        var mytop = this.y;
        var mybottom = this.y + (this.height);
        var otherleft = otherobj.x;
        var otherright = otherobj.x + (otherobj.width);
        var othertop = otherobj.y;
        var otherbottom = otherobj.y + (otherobj.height);
        var crash = true;
        if ((mybottom < othertop) || (mytop > otherbottom) || (myright < otherleft) || (myleft > otherright)) {
            crash = false;
        }
        return crash;
    }
        var canvas = document.getElementById("canvas")
       
}

function updateGameArea() {
    var x, height, gap, minHeight, maxHeight, minGap, maxGap;
    console.log("random element = "+selectedTarget) 
    
    myGameArea.clear();
    if(selectedTarget % 2 > 0){
        if(myTargets[selectedTarget].y > targetOddY){
            myTargets[selectedTarget].y += -1;
        }
    }else{
        if(myTargets[selectedTarget].y > targetEventY){
            myTargets[selectedTarget].y += -1;   
        }
    }
    myTargets[selectedTarget].update();    
    myGameArea.frameNo += 1;
    myScore.text="Time: " + (myGameArea.frameNo/100);
    myScore.update();   
    
    myRemainingQs.text="Questions remaining:" + questions;
    myRemainingQs.update();
    
	loggedInUser.text="Hello, "+email;
	loggedInUser.update();
	
    gameStalls.update();
    if(questions <=0){
        myGameArea.clear();
        myRemainingQs.text="Finished!";
        myRemainingQs.update();
        gameStalls.update();
		loggedInUser.update();
        clearInterval(interval);
        return;
    }
    
    if (targetSelected == false) {
        console.log("target hit, ending..") 
        myGameArea.clear();
        myTargets[selectedTarget].y = 330;
        myTargets[selectedTarget].update();    
        gameStalls.update();
        clearInterval(interval);
        myGameArea.start();
        questions --;
        return;
    } 
    
}

function everyinterval(n) {
    if ((myGameArea.frameNo / n) % 1 == 0) {return true;}
    return false;
}

function accelerate(n) {
    myGamePiece.gravity = n;
}
</script>
<!--
    <div id="message">
      <h2>Welcome</h2>
      <h1>Firebase Hosting Setup Complete</h1>
      <p>You're seeing this because you've successfully setup Firebase Hosting. Now it's time to go build something extraordinary!</p>
      <a target="_blank" href="https://firebase.google.com/docs/hosting/">Open Hosting Documentation</a>
    </div>
    <p id="load">Firebase SDK Loading&hellip;</p>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // // 🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
        // // The Firebase SDK is initialized and available here!
        //
        // firebase.auth().onAuthStateChanged(user => { });
        // firebase.database().ref('/path/to/ref').on('value', snapshot => { });
        // firebase.messaging().requestPermission().then(() => { });
        // firebase.storage().ref('/path/to/ref').getDownloadURL().then(() => { });
        //
        // // 🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
        try {
          let app = firebase.app();
          let features = ['auth', 'database', 'messaging', 'storage'].filter(feature => typeof app[feature] === 'function');
          document.getElementById('load').innerHTML = `Firebase SDK loaded with ${features.join(', ')}`;
        } catch (e) {
          console.error(e);
          document.getElementById('load').innerHTML = 'Error loading the Firebase SDK, check the console.';
        }
      });
    </script>
  -->
  </body>
</html>